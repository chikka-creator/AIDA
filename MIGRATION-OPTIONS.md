# Supabase + Prisma: Migration Options

## Option 1: Using Supabase SQL Editor

### Generate Migration SQL
```bash
# Generate SQL without applying it
npx prisma migrate diff \
  --from-empty \
  --to-schema-datamodel prisma/schema.prisma \
  --script > migration.sql
```

### Apply Migration via SQL Editor
1. Open [Supabase Dashboard](https://app.supabase.com)
2. Navigate to your project
3. Click "SQL Editor" in the left sidebar
4. Create "New Query"
5. Paste the generated SQL
6. Click "Run" to execute

### Example SQL for Your Schema
```sql
-- Enums
CREATE TYPE "AuthProvider" AS ENUM ('EMAIL', 'GOOGLE');
CREATE TYPE "UserRole" AS ENUM ('CUSTOMER', 'ADMIN');
CREATE TYPE "ProductCategory" AS ENUM ('LIGHTROOM_PRESET', 'PHOTOSHOP_ACTION', 'LUT', 'TEMPLATE', 'BUNDLE', 'OTHER');
CREATE TYPE "ProductStatus" AS ENUM ('DRAFT', 'ACTIVE', 'ARCHIVED');
CREATE TYPE "PurchaseStatus" AS ENUM ('PENDING', 'COMPLETED', 'FAILED', 'REFUNDED');
CREATE TYPE "PaymentMethod" AS ENUM ('E_WALLET', 'BANK_TRANSFER', 'CREDIT_CARD', 'QR_CODE');

-- Create tables
CREATE TABLE "users" (
    "id" TEXT NOT NULL,
    "email" TEXT NOT NULL,
    "username" TEXT,
    "password" TEXT,
    "name" TEXT,
    "phone" TEXT,
    "authProvider" "AuthProvider" NOT NULL DEFAULT 'EMAIL',
    "role" "UserRole" NOT NULL DEFAULT 'CUSTOMER',
    "emailVerified" BOOLEAN NOT NULL DEFAULT false,
    "isActive" BOOLEAN NOT NULL DEFAULT true,
    "createdAt" TIMESTAMP(3) NOT NULL DEFAULT CURRENT_TIMESTAMP,
    "updatedAt" TIMESTAMP(3) NOT NULL,
    "lastLogin" TIMESTAMP(3),

    CONSTRAINT "users_pkey" PRIMARY KEY ("id")
);

-- Add remaining tables (similar format)
-- Full SQL will be generated by prisma migrate diff

-- Indexes
CREATE UNIQUE INDEX "users_email_key" ON "users"("email");
CREATE UNIQUE INDEX "users_username_key" ON "users"("username");
CREATE INDEX "users_email_idx" ON "users"("email");

-- Add remaining indexes

-- Foreign Key Constraints
ALTER TABLE "accounts" ADD CONSTRAINT "accounts_userId_fkey" 
    FOREIGN KEY ("userId") REFERENCES "users"("id") ON DELETE CASCADE ON UPDATE CASCADE;

-- Add remaining constraints
```

### Benefits
- Works without IPv6 or direct connection
- Immediate feedback in UI
- Can review changes before applying
- Transaction support (can rollback if needed)

### Limitations
- Manual process
- Need to regenerate SQL for each schema change
- No automatic migration history

## Option 2: GitHub Actions Workflow

### 1. Create Workflow File
Create `.github/workflows/prisma-migrate.yml`:

```yaml
name: Prisma Migrate
on:
  workflow_dispatch:
    inputs:
      migration_name:
        description: 'Name for the migration'
        required: true
        default: 'db-update'

jobs:
  migrate:
    runs-on: ubuntu-latest
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          
      - name: Install dependencies
        run: npm ci
        
      - name: Generate Prisma Client
        run: npx prisma generate
        
      - name: Run migrations
        run: |
          if [[ "${{ github.event.inputs.migration_name }}" ]]; then
            npx prisma migrate dev --name ${{ github.event.inputs.migration_name }}
          else
            npx prisma migrate deploy
          fi
        env:
          DATABASE_URL: ${{ secrets.DIRECT_URL }}
```

### 2. Add Repository Secret
1. Go to your repository settings
2. Navigate to "Secrets and variables" â†’ "Actions"
3. Click "New repository secret"
4. Name: `DIRECT_URL`
5. Value: Your Supabase direct connection URL
   ```
   postgresql://postgres:weloveaidaagy@db.wzqohaehaqijfeqbrxlx.supabase.co:5432/postgres?sslmode=require
   ```

### 3. Run Migrations
Two ways to run:

1. Through GitHub UI:
   - Go to "Actions" tab
   - Select "Prisma Migrate" workflow
   - Click "Run workflow"
   - Enter migration name (for new migrations)
   - Click "Run workflow"

2. Via GitHub CLI:
   ```bash
   gh workflow run prisma-migrate --field migration_name=add-user-fields
   ```

### Benefits
- Works from any machine (GitHub runners have IPv6)
- Automated process
- Keeps migration history
- Can be integrated with CI/CD
- No local network/firewall issues

### Limitations
- Requires GitHub repository
- Need to set up secrets
- Slightly slower than direct SQL
- Need to wait for workflow to complete

## Recommended Approach

For development:
1. Use SQL Editor (Option 1) for quick iterations
2. Generate and save SQL files for important changes

For production:
1. Set up GitHub Actions (Option 2)
2. Use it for controlled, tracked migrations
3. Keep SQL files as backup

## Quick Start Commands

Generate SQL for SQL Editor:
```bash
# From schema to SQL
npx prisma migrate diff \
  --from-empty \
  --to-schema-datamodel prisma/schema.prisma \
  --script > migration.sql

# From current DB to new schema
npx prisma migrate diff \
  --from-url $DATABASE_URL \
  --to-schema-datamodel prisma/schema.prisma \
  --script > migration.sql
```

Set up GitHub Actions:
```bash
# Create workflows directory
mkdir -p .github/workflows

# Copy workflow file
# (Copy the yaml content above to prisma-migrate.yml)

# Add and commit
git add .github/workflows/prisma-migrate.yml
git commit -m "Add Prisma migration workflow"
git push
```

Remember to:
- Always backup your database before major changes
- Test migrations in development first
- Keep SQL files for reference
- Document significant schema changes